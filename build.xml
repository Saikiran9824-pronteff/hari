<?xml version="1.0" encoding="UTF-8"?>
<project name="apic-cicd" default="ci">

  <!-- ===============================
       Properties
  =============================== -->
  <property name="org" value="indusapi"/>
  <property name="catalog" value="${CATALOG_NAME}"/>
  <property name="api" value="${API_NAME}"/>
  <property name="product" value="${PRODUCT_NAME}.yaml"/>
  <property name="api_version" value="${API_VERSION}"/>
  <property name="env" value="${env}"/>
  <property name="publish" value="${publish}"/>

  <!-- ===============================
       CI Main Flow
  =============================== -->
  <target name="ci">
    <antcall target="validate"/>
    <antcall target="ref-update"/>
    <antcall target="api-draft"/>
    <antcall target="product-create-update"/>
    <antcall target="product-publish"/>
  </target>

  <!-- ===============================
       API Validation
  =============================== -->
  <target name="validate">
    <echo message="âœ… Validating API YAML for ${api}"/>
    <exec executable="apic">
      <arg value="apis:validate"/>
      <arg value="apis/${api}.yaml"/>
    </exec>
  </target>

  <!-- ===============================
       Fix $ref Paths in Product YAML
  =============================== -->
  <target name="ref-update">
    <echo message="ðŸ”§ Updating $ref paths in product file: ${product}"/>
    <exec executable="bash">
      <arg value="-c"/>
      <arg value="
        product='${product}';
        awk '
          {
            if (\$0 ~ /^[[:space:]]*\\$ref:[[:space:]]*[^\\.\\/][A-Za-z0-9._-]*\\.yaml([[:space:]]*(#.*)?)?$/ \
             || \$0 ~ /^[[:space:]]*\\$ref:[[:space:]]*[A-Za-z0-9._-]*\\.yaml([[:space:]]*(#.*)?)?$/ ) {
              sub(/\\$ref:[[:space:]]*/, \"&amp;amp;../apis/\");
            }
            print
          }
        ' \"${product}\" > \"${product}.tmp\" && mv \"${product}.tmp\" \"${product}\"
      "/>
    </exec>
  </target>

  <!-- ===============================
       API Draft Create/Update
  =============================== -->
  <target name="api-draft">
    <echo message="ðŸ“¦ Creating or Updating draft API ${api}:${api_version}"/>
    <exec executable="apic">
      <arg value="apis:create"/>
      <arg value="--org"/>
      <arg value="${org}"/>
      <arg value="--catalog"/>
      <arg value="${catalog}"/>
      <arg value="apis/${api}.yaml"/>
      <arg value="--server"/>
      <arg value="https://api-manager.indusind.com"/>
      <arg value="--api-version"/>
      <arg value="${api_version}"/>
      <arg value="--format"/>
      <arg value="yaml"/>
      <arg value="--apimanager"/>
      <arg value="true"/>
      <arg value="--space"/>
      <arg value="${env}"/>
      <arg value="--draft"/>
    </exec>
  </target>

  <!-- ===============================
       Product Create or Update
  =============================== -->
  <target name="product-create-update">
    <echo message="ðŸ“¦ Creating or Updating Product ${PRODUCT_NAME}"/>
    <exec executable="apic">
      <arg value="products:create"/>
      <arg value="--org"/>
      <arg value="${org}"/>
      <arg value="--catalog"/>
      <arg value="${catalog}"/>
      <arg value="products/${product}"/>
      <arg value="--server"/>
      <arg value="https://api-manager.indusind.com"/>
      <arg value="--format"/>
      <arg value="yaml"/>
      <arg value="--space"/>
      <arg value="${env}"/>
    </exec>
  </target>

  <!-- ===============================
       Product Publish (Optional)
  =============================== -->
  <target name="product-publish" if="publish">
    <echo message="ðŸš€ Publishing Product ${PRODUCT_NAME} to ${catalog} catalog"/>
    <exec executable="apic">
      <arg value="products:publish"/>
      <arg value="--org"/>
      <arg value="${org}"/>
      <arg value="--catalog"/>
      <arg value="${catalog}"/>
      <arg value="products/${product}"/>
      <arg value="--server"/>
      <arg value="https://api-manager.indusind.com"/>
      <arg value="--space"/>
      <arg value="${env}"/>
    </exec>
  </target>

</project>
