<project name="apic-cicd" default="bulk-ci" basedir=".">

  <!-- ==========================================================
       Load Ant-Contrib
  ========================================================== -->
  <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

  <!-- ==========================================================
       Properties
  ========================================================== -->
  <property name="GIT_REPO" value="https://github.com/Saikiran9824-pronteff/hari.git"/>
  <property name="APIC_SERVER" value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
  <property name="APIC_ORG"    value="indusapi-np"/>
  <property name="APIC_REALM"  value="provider/default-idp-2"/>
  <property name="APIC_USER"   value="umesh"/>
  <!-- ✅ FIXED: wrap password inside CDATA -->
  <property name="APIC_PASSWORD"><![CDATA[!n0r1t5&C]]></property>

  <!-- default catalog -->
  <property name="CATALOG_NAME" value="sandbox"/>

  <!-- ==========================================================
       LOGIN
  ========================================================== -->
  <target name="login">
    <echo message="🔐 Logging in to API Connect..."/>
    <exec executable="apic" failonerror="true">
      <arg value="login"/>
      <arg value="--server"/><arg value="${APIC_SERVER}"/>
      <arg value="--username"/><arg value="${APIC_USER}"/>
      <arg value="--password"/><arg value="${APIC_PASSWORD}"/>
      <arg value="--realm"/><arg value="${APIC_REALM}"/>
    </exec>
  </target>

  <!-- ==========================================================
       GIT CLONE
  ========================================================== -->
  <target name="git-clone">
    <echo message="📥 Cloning GitHub repo..."/>
    <exec executable="rm" failonerror="false">
      <arg value="-rf"/>
      <arg value="repo"/>
    </exec>
    <exec executable="git" failonerror="true">
      <arg value="clone"/>
      <arg value="${GIT_REPO}"/>
      <arg value="repo"/>
    </exec>
  </target>

  <!-- ==========================================================
       API Deploy Logic
  ========================================================== -->
  <target name="deploy-api">
    <echo message="⚙️ Processing API=${API_NAME}..."/>

    <!-- Check if API exists -->
    <exec executable="apic" outputproperty="api.exists" failonerror="false">
      <arg value="apis:get"/>
      <arg value="--server"/><arg value="${APIC_SERVER}"/>
      <arg value="--org"/><arg value="${APIC_ORG}"/>
      <arg value="${API_NAME}:${API_VERSION}"/>
    </exec>

    <if>
      <isset property="api.exists"/>
      <then>
        <echo message="♻️ Updating API ${API_NAME}:${API_VERSION}"/>
        <exec executable="apic" failonerror="true">
          <arg value="apis:update"/>
          <arg value="--server"/><arg value="${APIC_SERVER}"/>
          <arg value="--org"/><arg value="${APIC_ORG}"/>
          <arg value="repo/apis/${API_NAME}/api.yaml"/>
        </exec>
      </then>
      <else>
        <echo message="📦 Creating API ${API_NAME}:${API_VERSION}"/>
        <exec executable="apic" failonerror="true">
          <arg value="apis:create"/>
          <arg value="--server"/><arg value="${APIC_SERVER}"/>
          <arg value="--org"/><arg value="${APIC_ORG}"/>
          <arg value="repo/apis/${API_NAME}/api.yaml"/>
        </exec>
      </else>
    </if>
  </target>

  <!-- ==========================================================
       Product Deploy Logic
  ========================================================== -->
  <target name="deploy-product">
    <echo message="⚙️ Processing Product=${PRODUCT_NAME}..."/>

    <!-- Check if Product exists -->
    <exec executable="apic" outputproperty="product.exists" failonerror="false">
      <arg value="products:get"/>
      <arg value="--server"/><arg value="${APIC_SERVER}"/>
      <arg value="--org"/><arg value="${APIC_ORG}"/>
      <arg value="${PRODUCT_NAME}"/>
    </exec>

    <if>
      <isset property="product.exists"/>
      <then>
        <echo message="♻️ Updating Product ${PRODUCT_NAME}"/>
        <exec executable="apic" failonerror="true">
          <arg value="products:update"/>
          <arg value="--server"/><arg value="${APIC_SERVER}"/>
          <arg value="--org"/><arg value="${APIC_ORG}"/>
          <arg value="repo/products/${PRODUCT_NAME}/${PRODUCT_NAME}.yaml"/>
        </exec>
      </then>
      <else>
        <echo message="📦 Creating Product ${PRODUCT_NAME}"/>
        <exec executable="apic" failonerror="true">
          <arg value="products:create"/>
          <arg value="--server"/><arg value="${APIC_SERVER}"/>
          <arg value="--org"/><arg value="${APIC_ORG}"/>
          <arg value="repo/products/${PRODUCT_NAME}/${PRODUCT_NAME}.yaml"/>
        </exec>
      </else>
    </if>

    <!-- Publish after create/update -->
    <echo message="🚀 Publishing Product ${PRODUCT_NAME} to catalog ${CATALOG_NAME}"/>
    <exec executable="apic" failonerror="true">
      <arg value="publish"/>
      <arg value="--server"/><arg value="${APIC_SERVER}"/>
      <arg value="--org"/><arg value="${APIC_ORG}"/>
      <arg value="--catalog"/><arg value="${CATALOG_NAME}"/>
      <arg value="repo/products/${PRODUCT_NAME}/${PRODUCT_NAME}.yaml"/>
    </exec>
  </target>

  <!-- ==========================================================
       BULK LOOP (APIs + Products)
  ========================================================== -->
  <target name="bulk-ci" depends="login,git-clone">
    <!-- APIs -->
    <foreach target="deploy-api" param="API_NAME">
      <path>
        <fileset dir="repo/apis" includes="*"/>
      </path>
    </foreach>

    <!-- Products -->
    <foreach target="deploy-product" param="PRODUCT_NAME">
      <path>
        <fileset dir="repo/products" includes="*"/>
      </path>
    </foreach>

    <echo message="🎉 Bulk deployment completed for all APIs & Products!"/>
  </target>

</project>
