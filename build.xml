<project name="apic-cicd-pipeline" default="ci">

  <!-- ========= Properties ========= -->
  <property name="API_NAME" value="loan-api"/>
  <property name="API_VERSION" value="1.0.0"/>
  <property name="PRODUCT_NAME" value="loan-product"/>
  <property name="CATALOG_NAME" value="prod"/>
  <property name="env" value="dev"/>

  <property name="api" value="apis/${API_NAME}_${API_VERSION}.yaml"/>
  <property name="product" value="products/${PRODUCT_NAME}_${API_VERSION}.yaml"/>

  <!-- ========= Validate API ========= -->
  <target name="validate">
    <echo message="âœ… Validating API YAML for ${API_NAME}"/>
    <exec executable="apic" failonerror="true">
      <arg value="validate"/>
      <arg value="${api}"/>
    </exec>
  </target>

  <!-- ========= API Draft ========= -->
  <target name="api-draft" depends="validate">
    <echo message="ðŸ“¦ Creating or Updating draft API ${API_NAME}:${API_VERSION}"/>
    <exec executable="apic" failonerror="true">
      <arg value="draft-apis:create"/>
      <arg value="${api}"/>
      <arg value="--server"/>
      <arg value="https://api-manager.example.com"/>
      <arg value="--org"/>
      <arg value="indusapi"/>
    </exec>
  </target>

  <!-- ========= Ref Update (AFTER API DRAFT) ========= -->
  <target name="ref-update" depends="api-draft">
    <echo message="ðŸ”§ Updating $ref paths in product file: ${product}"/>
    <exec executable="sed" failonerror="true">
      <arg value="-i"/>
      <arg value="s|\$ref:[[:space:]]*\(.*\.yaml\)|\$ref: ../apis/\1|g"/>
      <arg value="${product}"/>
    </exec>
  </target>

  <!-- ========= Product Draft (AFTER REF UPDATE) ========= -->
  <target name="product-draft" depends="ref-update">
    <echo message="ðŸ“¦ Creating or Updating draft Product ${PRODUCT_NAME}:${API_VERSION}"/>
    <exec executable="apic" failonerror="true">
      <arg value="draft-products:create"/>
      <arg value="${product}"/>
      <arg value="--server"/>
      <arg value="https://api-manager.example.com"/>
      <arg value="--org"/>
      <arg value="indusapi"/>
    </exec>
  </target>

  <!-- ========= Publish ========= -->
  <target name="publish" depends="product-draft">
    <echo message="ðŸš€ Publishing Product ${PRODUCT_NAME}:${API_VERSION} to catalog ${CATALOG_NAME}"/>
    <exec executable="apic" failonerror="true">
      <arg value="products:publish"/>
      <arg value="${product}"/>
      <arg value="--catalog"/>
      <arg value="${CATALOG_NAME}"/>
      <arg value="--server"/>
      <arg value="https://api-manager.example.com"/>
      <arg value="--org"/>
      <arg value="indusapi"/>
    </exec>
  </target>

  <!-- ========= CI Pipeline ========= -->
  <target name="ci" depends="publish">
    <echo message="âœ… CI Pipeline completed for ${API_NAME}:${API_VERSION}"/>
  </target>

</project>
