<?xml version="1.0" encoding="UTF-8"?>
<project name="apic-cicd" default="ci" basedir=".">

    <!-- =============================== -->
    <!--  Hardcoded APIC login details   -->
    <!-- =============================== -->
    <target name="login">
        <echo message="ðŸ” Logging in to API Connect..."/>
        <exec executable="apic" failonerror="true">
            <arg value="login"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--username"/>
            <arg value="umesh"/>
            <arg value="--password"/>
            <arg value="!n0r1t5@C"/>
            <arg value="--realm"/>
            <arg value="provider/default-idp-2"/>
        </exec>
    </target>

    <!-- =============================== -->
    <!--  Bulk API processing (loop)     -->
    <!-- =============================== -->
    <target name="bulk-apis" depends="login">
        <foreach target="api-flow" param="api.file" delimiter=",">
            <path>
                <fileset dir="apis" includes="*.yaml"/>
            </path>
        </foreach>
    </target>

    <target name="api-flow">
        <!-- Extract name + version from filename (myapi_1.0.0.yaml) -->
        <basename property="api.filename" file="${api.file}" suffix=".yaml"/>
        <propertyregex property="API_NAME" input="${api.filename}" regexp="(.*)_.*" select="\1"/>
        <propertyregex property="API_VERSION" input="${api.filename}" regexp=".*_(.*)" select="\1"/>
        <echo message="âž¡ï¸ Processing API: ${API_NAME}:${API_VERSION}"/>
        <antcall target="api-process"/>
    </target>

    <!-- =============================== -->
    <!--  API check/create/update        -->
    <!-- =============================== -->
    <target name="validate">
        <exec executable="apic" failonerror="true">
            <arg value="validate"/>
            <arg value="apis/${API_NAME}_${API_VERSION}.yaml"/>
        </exec>
    </target>

    <target name="api-check" depends="validate">
        <exec executable="apic" failonerror="false" outputproperty="api.exists">
            <arg value="draft-apis:get"/>
            <arg value="${API_NAME}:${API_VERSION}"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
        </exec>
    </target>

    <target name="api-process" depends="api-check">
        <condition property="api.exists.true">
            <matches string="${api.exists}" pattern=".*${API_NAME}:${API_VERSION}.*"/>
        </condition>
        <antcall target="api-update"/>
        <antcall target="api-create"/>
    </target>

    <target name="api-create" unless="api.exists.true">
        <exec executable="apic" failonerror="true">
            <arg value="draft-apis:create"/>
            <arg value="apis/${API_NAME}_${API_VERSION}.yaml"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
        </exec>
    </target>

    <target name="api-update" if="api.exists.true">
        <exec executable="apic" failonerror="true">
            <arg value="draft-apis:update"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
            <arg value="${API_NAME}:${API_VERSION}"/>
            <arg value="apis/${API_NAME}_${API_VERSION}.yaml"/>
        </exec>
    </target>

    <!-- =============================== -->
    <!--  Bulk Product processing (loop) -->
    <!-- =============================== -->
    <target name="bulk-products" depends="bulk-apis">
        <foreach target="product-flow" param="product.file" delimiter=",">
            <path>
                <fileset dir="products" includes="*.yaml"/>
            </path>
        </foreach>
    </target>

    <target name="product-flow">
        <basename property="product.filename" file="${product.file}" suffix=".yaml"/>
        <propertyregex property="PRODUCT_NAME" input="${product.filename}" regexp="(.*)_.*" select="\1"/>
        <propertyregex property="API_VERSION" input="${product.filename}" regexp=".*_(.*)" select="\1"/>
        <echo message="âž¡ï¸ Processing Product: ${PRODUCT_NAME}:${API_VERSION}"/>
        <antcall target="product-process"/>
    </target>

    <!-- =============================== -->
    <!--  Product check/create/update    -->
    <!-- =============================== -->
    <target name="product-check">
        <exec executable="apic" failonerror="false" outputproperty="product.exists">
            <arg value="draft-products:get"/>
            <arg value="${PRODUCT_NAME}:${API_VERSION}"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
        </exec>
    </target>

    <target name="product-process" depends="product-check">
        <condition property="product.exists.true">
            <matches string="${product.exists}" pattern=".*${PRODUCT_NAME}:${API_VERSION}.*"/>
        </condition>
        <antcall target="product-update"/>
        <antcall target="product-create"/>
    </target>

    <target name="product-create" unless="product.exists.true">
        <exec executable="apic" failonerror="true">
            <arg value="draft-products:create"/>
            <arg value="products/${PRODUCT_NAME}_${API_VERSION}.yaml"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
        </exec>
    </target>

    <target name="product-update" if="product.exists.true">
        <exec executable="apic" failonerror="true">
            <arg value="draft-products:update"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
            <arg value="${PRODUCT_NAME}:${API_VERSION}"/>
            <arg value="products/${PRODUCT_NAME}_${API_VERSION}.yaml"/>
        </exec>
    </target>

    <!-- =============================== -->
    <!--  CI flow entry point            -->
    <!-- =============================== -->
    <target name="ci" depends="bulk-products">
        <echo message="ðŸŽ‰ Bulk CI/CD pipeline completed successfully!"/>
    </target>

</project>
