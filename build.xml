<?xml version="1.0" encoding="UTF-8"?>
<project name="apic-cicd-pipeline" default="publish">

    <!-- =================== Properties =================== -->
    <property name="API_NAME" value="loan-api"/>
    <property name="API_VERSION" value="1.0.0"/>
    <property name="PRODUCT_NAME" value="loan-product"/>
    <property name="PRODUCT_FILE" value="products/${PRODUCT_NAME}_${API_VERSION}.yaml"/>
    <property name="APIS_DIR" value="apis"/>
    <property name="PRODUCTS_DIR" value="products"/>

    <!-- =================== Login =================== -->
    <target name="login">
        <echo message="ðŸ”‘ Logging into APIC..."/>
        <exec executable="apic">
            <arg value="login"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--username"/>
            <arg value="${APIC_USERNAME}"/>
            <arg value="--password"/>
            <arg value="${APIC_PASSWORD}"/>
            <arg value="--realm"/>
            <arg value="provider/default-idp-2"/>
        </exec>
    </target>

    <!-- =================== Validate =================== -->
    <target name="validate" depends="login">
        <echo message="âœ… Validating API YAML for ${API_NAME}"/>
        <exec executable="apic">
            <arg value="validate"/>
            <arg value="${APIS_DIR}/${API_NAME}.yaml"/>
        </exec>
    </target>

    <!-- =================== API Draft =================== -->
    <target name="api-process" depends="validate">
        <echo message="ðŸ“¦ Creating or Updating draft API ${API_NAME}:${API_VERSION}"/>
        <exec executable="apic">
            <arg value="draft-apis:create"/>
            <arg value="${APIS_DIR}/${API_NAME}.yaml"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
        </exec>
    </target>

    <!-- =================== Product Check =================== -->
    <target name="product-check" depends="api-process">
        <echo message="ðŸ”Ž Checking if Product exists..."/>
        <exec executable="apic" failonerror="false" outputproperty="product.exists">
            <arg value="draft-products:get"/>
            <arg value="${PRODUCT_NAME}:${API_VERSION}"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
        </exec>
        <echo message="Product exists? ${product.exists}"/>
    </target>

    <!-- =================== Fix Product $ref Paths =================== -->
    <target name="fix-product-refs">
        <echo message="ðŸ›  Fixing $ref paths in product YAMLs..."/>
        <exec executable="bash">
            <arg value="-c"/>
            <arg line="
              find ${PRODUCTS_DIR} -type f -name '*.yaml' | sort | while read -r product; do
                awk '
                  {
                    if (\$0 ~ /^[[:space:]]*\\$ref:[[:space:]]*[^\\.\\/][A-Za-z0-9._-]*\\.yaml([[:space:]]*(#.*)?)?$/ \
                     || \$0 ~ /^[[:space:]]*\\$ref:[[:space:]]*[A-Za-z0-9._-]*\\.yaml([[:space:]]*(#.*)?)?$/ ) {
                      sub(/\\$ref:[[:space:]]*/, \"&../apis/\");
                    }
                    print
                  }
                ' \"${product}\" > \"${product}.tmp\" && mv \"${product}.tmp\" \"${product}\"
              done
            "/>
        </exec>
    </target>

    <!-- =================== Product Process =================== -->
    <target name="product-process" depends="product-check,fix-product-refs">
        <condition property="product.exists.true">
            <and>
                <isset property="product.exists"/>
                <matches string="${product.exists}" pattern=".*${PRODUCT_NAME}:${API_VERSION}.*"/>
            </and>
        </condition>
        <antcall target="product-update"/>
        <antcall target="product-create"/>
    </target>

    <!-- =================== Product Update =================== -->
    <target name="product-update" if="product.exists.true">
        <echo message="ðŸ”„ Updating Product ${PRODUCT_NAME}:${API_VERSION}"/>
        <exec executable="apic">
            <arg value="draft-products:update"/>
            <arg value="${PRODUCT_FILE}"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
        </exec>
    </target>

    <!-- =================== Product Create =================== -->
    <target name="product-create" unless="product.exists.true">
        <echo message="ðŸ†• Creating Product ${PRODUCT_NAME}:${API_VERSION}"/>
        <exec executable="apic">
            <arg value="draft-products:create"/>
            <arg value="${PRODUCT_FILE}"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
        </exec>
    </target>

    <!-- =================== Publish =================== -->
    <target name="publish" depends="product-process">
        <echo message="ðŸš€ Publishing Product ${PRODUCT_NAME}:${API_VERSION}"/>
        <exec executable="apic">
            <arg value="products:publish"/>
            <arg value="${PRODUCT_FILE}"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
            <arg value="--catalog"/>
            <arg value="sandbox"/>
        </exec>
    </target>

    <!-- =================== Backup =================== -->
    <target name="backup" depends="publish">
        <echo message="ðŸ’¾ Backing up Product YAML..."/>
        <copy file="${PRODUCT_FILE}" tofile="backup/${PRODUCT_NAME}_${API_VERSION}.yaml"/>
    </target>

</project>
