  <!-- ==========================================================
       BULK Deployment Wrapper (using foreach + do)
  ========================================================== -->
  <target name="bulk-ci" depends="login">
    <echo message="ðŸš€ Bulk deploy to catalog=${CATALOG_NAME} using ${csv.file}"/>

    <!-- Read CSV as one string -->
    <loadfile property="csv.content" srcFile="${csv.file}"/>

    <!-- Iterate line by line -->
    <foreach list="${csv.content}" delimiter="${line.separator}" param="line">
      <do>
        <!-- Skip empty lines -->
        <condition property="skip.line">
          <or>
            <equals arg1="@{line}" arg2=""/>
            <matches string="@{line}" pattern="^\s*$"/>
          </or>
        </condition>
        <if>
          <isset property="skip.line"/>
          <then><echo message="(skip empty line)"/></then>
          <else>
            <!-- Skip header -->
            <if>
              <and>
                <not><isset property="header.processed"/></not>
                <matches string="@{line}" pattern="(?i)^API_NAME,API_VERSION,PRODUCT_NAME"/>
              </and>
              <then>
                <property name="header.processed" value="true"/>
                <echo message="ðŸ“‹ Header detected, skipping"/>
              </then>
              <else>
                <!-- Parse CSV fields -->
                <propertyregex property="API_NAME"     input="@{line}" regexp="^\s*([^,]+),([^,]+),([^,]+)\s*$" select="\1"/>
                <propertyregex property="API_VERSION"  input="@{line}" regexp="^\s*([^,]+),([^,]+),([^,]+)\s*$" select="\2"/>
                <propertyregex property="PRODUCT_NAME" input="@{line}" regexp="^\s*([^,]+),([^,]+),([^,]+)\s*$" select="\3"/>

                <!-- Trim spaces -->
                <propertyregex property="API_NAME"     input="${API_NAME}"     regexp="^\s*(.*?)\s*$" select="\1"/>
                <propertyregex property="API_VERSION"  input="${API_VERSION}"  regexp="^\s*(.*?)\s*$" select="\1"/>
                <propertyregex property="PRODUCT_NAME" input="${PRODUCT_NAME}" regexp="^\s*(.*?)\s*$" select="\1"/>

                <echo message="âž¡ï¸  Deploying API=${API_NAME}, VERSION=${API_VERSION}, PRODUCT=${PRODUCT_NAME}, CATALOG=${CATALOG_NAME}"/>

                <!-- Call single-run -->
                <antcall target="ci">
                  <param name="API_NAME" value="${API_NAME}"/>
                  <param name="API_VERSION" value="${API_VERSION}"/>
                  <param name="PRODUCT_NAME" value="${PRODUCT_NAME}"/>
                </antcall>
              </else>
            </if>
          </else>
        </if>
      </do>
    </foreach>
  </target>
