<project name="apic-cicd" default="bulk-ci" basedir=".">

  <!-- ==========================================================
       Load Ant-Contrib (foreach, if, propertyregex, etc.)
       Make sure ant-contrib-1.0b3.jar is in /usr/share/ant/lib
  ========================================================== -->
  <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

  <!-- ==========================================================
       Properties
  ========================================================== -->
  <property name="csv.file" value="deploy_list.csv"/>

  <!-- APIC Server / Org / Realm -->
  <property name="APIC_SERVER" value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
  <property name="APIC_ORG"    value="indusapi-np"/>
  <property name="APIC_REALM"  value="provider/default-idp-2"/>

  <!-- ==========================================================
       LOGIN
  ========================================================== -->
  <target name="login">
    <echo message="ðŸ” Logging in to API Connect..."/>
    <exec executable="apic" failonerror="true">
      <arg value="login"/>
      <arg value="--server"/><arg value="${APIC_SERVER}"/>
      <arg value="--username"/><arg value="umesh"/>
      <arg value="--password"/><arg value="!n0r1t5@C"/>
      <arg value="--realm"/><arg value="${APIC_REALM}"/>
    </exec>
  </target>

  <!-- ==========================================================
       API Targets
  ========================================================== -->
  <target name="api-process">
    <echo message="âš™ï¸ Processing API ${API_NAME}:${API_VERSION}..."/>
  </target>

  <target name="api-create">
    <echo message="ðŸ“¦ Creating API ${API_NAME}:${API_VERSION}..."/>
  </target>

  <target name="api-update">
    <echo message="â™»ï¸ Updating API ${API_NAME}:${API_VERSION}..."/>
  </target>

  <!-- ==========================================================
       Product Targets
  ========================================================== -->
  <target name="product-process">
    <echo message="âš™ï¸ Processing Product ${PRODUCT_NAME}..."/>
  </target>

  <target name="product-create">
    <echo message="ðŸ“¦ Creating Product ${PRODUCT_NAME}..."/>
  </target>

  <target name="product-update">
    <echo message="â™»ï¸ Updating Product ${PRODUCT_NAME}..."/>
  </target>

  <!-- ==========================================================
       Publish to Catalog
  ========================================================== -->
  <target name="publish">
    <echo message="ðŸš€ Publishing Product ${PRODUCT_NAME} to catalog ${CATALOG_NAME}..."/>
    <exec executable="apic" failonerror="true">
      <arg value="publish"/>
      <arg value="--server"/><arg value="${APIC_SERVER}"/>
      <arg value="--org"/><arg value="${APIC_ORG}"/>
      <arg value="--catalog"/><arg value="${CATALOG_NAME}"/>
      <arg value="products/${PRODUCT_NAME}/${PRODUCT_NAME}.yaml"/>
    </exec>
  </target>

  <!-- ==========================================================
       CI Single Run
  ========================================================== -->
  <target name="ci" depends="api-process,product-process,publish">
    <echo message="ðŸŽ‰ CI/CD pipeline completed for API=${API_NAME}, Product=${PRODUCT_NAME}"/>
  </target>

  <!-- ==========================================================
       BULK Deployment Wrapper (foreach + do)
  ========================================================== -->
  <target name="bulk-ci" depends="login">
    <echo message="ðŸš€ Bulk deploy to catalog=${CATALOG_NAME} using ${csv.file}"/>

    <!-- Read CSV as one string -->
    <loadfile property="csv.content" srcFile="${csv.file}"/>

    <!-- Iterate line by line -->
    <foreach list="${csv.content}" delimiter="${line.separator}" param="line">
      <do>
        <!-- Skip empty lines -->
        <if>
          <equals arg1="@{line}" arg2=""/>
          <then><echo message="(skip empty line)"/></then>
          <else>
            <!-- Skip header -->
            <if>
              <matches string="@{line}" pattern="(?i)^API_NAME,API_VERSION,PRODUCT_NAME"/>
              <then>
                <echo message="ðŸ“‹ Header detected, skipping"/>
              </then>
              <else>
                <!-- Parse CSV fields -->
                <propertyregex property="API_NAME"     input="@{line}" regexp="^\s*([^,]+),([^,]+),([^,]+)\s*$" select="\1"/>
                <propertyregex property="API_VERSION"  input="@{line}" regexp="^\s*([^,]+),([^,]+),([^,]+)\s*$" select="\2"/>
                <propertyregex property="PRODUCT_NAME" input="@{line}" regexp="^\s*([^,]+),([^,]+),([^,]+)\s*$" select="\3"/>

                <echo message="âž¡ï¸ Deploying API=${API_NAME}, VERSION=${API_VERSION}, PRODUCT=${PRODUCT_NAME}, CATALOG=${CATALOG_NAME}"/>

                <!-- Call single-run -->
                <antcall target="ci">
                  <param name="API_NAME" value="${API_NAME}"/>
                  <param name="API_VERSION" value="${API_VERSION}"/>
                  <param name="PRODUCT_NAME" value="${PRODUCT_NAME}"/>
                </antcall>
              </else>
            </if>
          </else>
        </if>
      </do>
    </foreach>
  </target>

</project>
