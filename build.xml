<project name="apic-cicd" default="bulk-ci" basedir=".">
  <!-- Load Ant-Contrib -->
  <taskdef resource="net/sf/antcontrib/antcontrib.properties"
           classpath="lib/ant-contrib-1.0b3.jar"/>
  
  <!-- Properties -->
  <property name="GIT_REPO" value="https://github.com/Saikiran9824-pronteff/hari.git"/>
  <property name="APIC_SERVER" value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
  <property name="APIC_ORG" value="indusapi-np"/>
  <property name="APIC_USER" value="umesh"/>
  <property environment="env"/>
  <property name="APIC_PASSWORD" value="${env.APIC_PASSWORD}"/>
  <property name="CATALOG_NAME" value="sandbox"/>
  
  <!-- Login -->
  <target name="login">
    <echo message="ðŸ”‘ Logging in to API Connect..."/>
    <exec executable="apic" failonerror="true">
      <arg line="login --server ${APIC_SERVER} --username ${APIC_USER} --password ${APIC_PASSWORD}"/>
    </exec>
  </target>
  
  <!-- Git clone -->
  <target name="git-clone">
    <echo message="ðŸ“¥ Cloning GitHub repo..."/>
    <exec executable="rm" failonerror="false">
      <arg value="-rf"/>
      <arg value="repo"/>
    </exec>
    <exec executable="git" failonerror="true">
      <arg line="clone ${GIT_REPO} repo"/>
    </exec>
  </target>
  
  <!-- Deploy API -->
  <target name="deploy-api">
    <echo message="âš™ï¸ Processing API_FILE=${API_FILE}..."/>
    <basename property="API_BASENAME" file="${API_FILE}" suffix=".yaml"/>
    <propertyregex property="API_NAME" input="${API_BASENAME}" regexp="(.+)_([0-9.]+)" select="\1"/>
    <propertyregex property="API_VERSION" input="${API_BASENAME}" regexp="(.+)_([0-9.]+)" select="\2"/>
    <echo message="Parsed API_NAME=${API_NAME}, API_VERSION=${API_VERSION}"/>
    
    <!-- Check if draft API exists -->
    <exec executable="apic" outputproperty="api.exists.true" failonerror="false">
      <arg line="draft-apis:get --server ${APIC_SERVER} --org ${APIC_ORG} ${API_NAME}:${API_VERSION}"/>
    </exec>
    
    <antcall target="api-update">
      <param name="API_EXISTS" value="${api.exists.true}"/>
    </antcall>
  </target>
  
  <target name="api-create" unless="API_EXISTS">
    <echo message="ðŸ†• Creating new draft API ${API_NAME}:${API_VERSION}"/>
    <exec executable="apic" failonerror="true">
      <arg value="draft-apis:create"/>
      <arg value="${API_FILE}"/>
      <arg value="--server"/>
      <arg value="${APIC_SERVER}"/>
      <arg value="--org"/>
      <arg value="${APIC_ORG}"/>
    </exec>
  </target>

  <target name="api-update" if="API_EXISTS">
    <echo message="â™»ï¸ Updating existing draft API ${API_NAME}:${API_VERSION}"/>
    <exec executable="apic" failonerror="true">
      <arg value="draft-apis:update"/>
      <arg value="${API_NAME}:${API_VERSION}"/>
      <arg value="${API_FILE}"/>
      <arg value="--server"/>
      <arg value="${APIC_SERVER}"/>
      <arg value="--org"/>
      <arg value="${APIC_ORG}"/>
    </exec>
  </target>

  <!-- Deploy Product -->
  <target name="deploy-product">
    <echo message="âš™ï¸ Processing PRODUCT_FILE=${PRODUCT_FILE}..."/>
    <propertyregex property="PRODUCT_NAME" input="${PRODUCT_FILE}" regexp="([^/]+)/([^/]+)\.yaml$" select="\2"/>
    
    <!-- Check if Product exists -->
    <exec executable="apic" outputproperty="product.exists.true" failonerror="false">
      <arg line="products:get --server ${APIC_SERVER} --org ${APIC_ORG} ${PRODUCT_NAME}"/>
    </exec>
    
    <if>
      <isset property="product.exists.true"/>
      <then>
        <echo message="â™»ï¸ Updating Product ${PRODUCT_NAME}"/>
        <exec executable="apic" failonerror="true">
          <arg line="products:update --server ${APIC_SERVER} --org ${APIC_ORG} ${PRODUCT_FILE}"/>
        </exec>
      </then>
      <else>
        <echo message="ðŸ†• Creating Product ${PRODUCT_NAME}"/>
        <exec executable="apic" failonerror="true">
          <arg line="products:create --server ${APIC_SERVER} --org ${APIC_ORG} ${PRODUCT_FILE}"/>
        </exec>
      </else>
    </if>
    
    <echo message="ðŸš€ Publishing Product ${PRODUCT_NAME} to catalog ${CATALOG_NAME}"/>
    <exec executable="apic" failonerror="true">
      <arg line="publish --server ${APIC_SERVER} --org ${APIC_ORG} --catalog ${CATALOG_NAME} ${PRODUCT_FILE}"/>
    </exec>
  </target>
  
  <!-- Bulk CI -->
  <target name="bulk-ci" depends="login,git-clone">
    <foreach target="deploy-api" param="API_FILE">
      <path>
        <fileset dir="repo/apis" includes="**/*.yaml"/>
      </path>
    </foreach>

    <foreach target="deploy-product" param="PRODUCT_FILE">
      <path>
        <fileset dir="repo/products" includes="**/*.yaml"/>
      </path>
    </foreach>

    <echo message="ðŸŽ‰ Bulk deployment completed for all APIs & Products!"/>
  </target>
</project>
