<project name="apic-cicd" default="bulk-ci" basedir=".">

  <!-- ==========================================================
       Ant-Contrib (foreach, if, etc.)
  ========================================================== -->
  <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

  <!-- ==========================================================
       Properties
  ========================================================== -->
  <!-- CSV path can be overridden with -Dcsv.file=... -->
  <property name="csv.file" value="deploy_list.csv"/>

  <!-- APIC Server / Org / Realm -->
  <property name="APIC_SERVER" value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
  <property name="APIC_ORG"    value="indusapi-np"/>
  <property name="APIC_REALM"  value="provider/default-idp-2"/>

  <!-- ==========================================================
       LOGIN (hardcoded credentials)
  ========================================================== -->
  <target name="login">
    <echo message="ðŸ” Logging in to API Connect..."/>
    <exec executable="apic" failonerror="true">
      <arg value="login"/>
      <arg value="--server"/><arg value="${APIC_SERVER}"/>
      <arg value="--username"/><arg value="umesh"/>
      <arg value="--password"/><arg value="!n0r1t5@C"/>
      <arg value="--realm"/><arg value="${APIC_REALM}"/>
    </exec>
  </target>

  <!-- ==========================================================
       API Targets
  ========================================================== -->
  <target name="api-check">
    <echo message="ðŸ” Checking if API ${API_NAME}:${API_VERSION} exists..."/>
    <!-- Add apic commands for check here -->
  </target>

  <target name="api-process">
    <echo message="âš™ï¸ Processing API ${API_NAME}:${API_VERSION}..."/>
    <!-- Add processing logic -->
  </target>

  <target name="api-create">
    <echo message="ðŸ“¦ Creating API ${API_NAME}:${API_VERSION}..."/>
    <!-- Add apic commands for create -->
  </target>

  <target name="api-update">
    <echo message="â™»ï¸ Updating API ${API_NAME}:${API_VERSION}..."/>
    <!-- Add apic commands for update -->
  </target>

  <!-- ==========================================================
       Product Targets
  ========================================================== -->
  <target name="product-check">
    <echo message="ðŸ” Checking if Product ${PRODUCT_NAME} exists..."/>
    <!-- Add apic commands for check -->
  </target>

  <target name="product-process">
    <echo message="âš™ï¸ Processing Product ${PRODUCT_NAME}..."/>
    <!-- Add processing logic -->
  </target>

  <target name="product-create">
    <echo message="ðŸ“¦ Creating Product ${PRODUCT_NAME}..."/>
    <!-- Add apic commands for create -->
  </target>

  <target name="product-update">
    <echo message="â™»ï¸ Updating Product ${PRODUCT_NAME}..."/>
    <!-- Add apic commands for update -->
  </target>

  <!-- ==========================================================
       Publish to Catalog
  ========================================================== -->
  <target name="publish">
    <echo message="ðŸš€ Publishing Product ${PRODUCT_NAME} to catalog ${CATALOG_NAME}..."/>
    <exec executable="apic" failonerror="true">
      <arg value="publish"/>
      <arg value="--server"/><arg value="${APIC_SERVER}"/>
      <arg value="--org"/><arg value="${APIC_ORG}"/>
      <arg value="--catalog"/><arg value="${CATALOG_NAME}"/>
      <arg value="products/${PRODUCT_NAME}/${PRODUCT_NAME}.yaml"/>
    </exec>
  </target>

  <!-- ==========================================================
       Backup
  ========================================================== -->
  <target name="backup">
    <echo message="ðŸ’¾ Backing up Product ${PRODUCT_NAME} before deployment..."/>
    <!-- Add backup logic -->
  </target>

  <!-- ==========================================================
       CI Single Run
  ========================================================== -->
  <target name="ci" depends="api-process,product-process,publish">
    <echo message="ðŸŽ‰ CI/CD pipeline completed successfully for API=${API_NAME}, Product=${PRODUCT_NAME}"/>
  </target>

  <!-- ==========================================================
       BULK Deployment Wrapper
  ========================================================== -->
  <target name="bulk-ci" depends="login">
    <echo message="ðŸš€ Bulk deploy to catalog=${CATALOG_NAME} using ${csv.file}"/>

    <!-- Read CSV as one string -->
    <loadfile property="csv.content" srcFile="${csv.file}"/>

    <!-- Iterate line by line -->
    <foreach list="${csv.content}" delimiter="${line.separator}" param="line">
      <sequential>
        <!-- Skip empty lines -->
        <condition property="skip.line">
          <or>
            <equals arg1="@{line}" arg2=""/>
            <matches string="@{line}" pattern="^\s*$"/>
          </or>
        </condition>
        <if>
          <isset property="skip.line"/>
          <then><echo message="(skip empty line)"/></then>
          <else>
            <!-- Skip header -->
            <if>
              <and>
                <not><isset property="header.processed"/></not>
                <matches string="@{line}" pattern="(?i)^API_NAME,API_VERSION,PRODUCT_NAME"/>
              </and>
              <then>
                <property name="header.processed" value="true"/>
                <echo message="ðŸ“‹ Header detected, skipping"/>
              </then>
              <else>
                <!-- Parse CSV fields -->
                <propertyregex property="API_NAME"     input="@{line}" regexp="^\s*([^,]+),([^,]+),([^,]+)\s*$" select="\1"/>
                <propertyregex property="API_VERSION"  input="@{line}" regexp="^\s*([^,]+),([^,]+),([^,]+)\s*$" select="\2"/>
                <propertyregex property="PRODUCT_NAME" input="@{line}" regexp="^\s*([^,]+),([^,]+),([^,]+)\s*$" select="\3"/>

                <!-- Trim spaces -->
                <propertyregex property="API_NAME"     input="${API_NAME}"     regexp="^\s*(.*?)\s*$" select="\1"/>
                <propertyregex property="API_VERSION"  input="${API_VERSION}"  regexp="^\s*(.*?)\s*$" select="\1"/>
                <propertyregex property="PRODUCT_NAME" input="${PRODUCT_NAME}" regexp="^\s*(.*?)\s*$" select="\1"/>

                <echo message="âž¡ï¸  Deploying API=${API_NAME}, VERSION=${API_VERSION}, PRODUCT=${PRODUCT_NAME}, CATALOG=${CATALOG_NAME}"/>

                <!-- Call single-run -->
                <antcall target="ci">
                  <param name="API_NAME" value="${API_NAME}"/>
                  <param name="API_VERSION" value="${API_VERSION}"/>
                  <param name="PRODUCT_NAME" value="${PRODUCT_NAME}"/>
                  <!-- CATALOG_NAME comes from Jenkins UI parameter -->
                </antcall>
              </else>
            </if>
          </else>
        </if>
      </sequential>
    </foreach>
  </target>

</project>
