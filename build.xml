<project name="apic-cicd-pipeline" default="ci" basedir=".">

    <!-- =================== ant-contrib foreach =================== -->
    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="ant-contrib-1.0b3.jar"/>
        </classpath>
    </taskdef>

    <!-- =================== Properties =================== -->
    <property name="APIS_DIR" value="apis"/>
    <property name="PRODUCTS_DIR" value="products"/>
    <property name="SERVER" value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
    <property name="ORG" value="prod"/>

    <!-- =================== Login =================== -->
    <target name="login">
        <echo message="ðŸ” Logging in to API Connect..."/>
        <exec executable="apic" failonerror="true">
            <arg value="login"/>
            <arg value="-s"/>
            <arg value="${SERVER}"/>
            <arg value="-u"/>
            <arg value="umesh"/>
            <arg value="-p"/>
            <arg value="!n0r1t5@C"/>
            <arg value="--realm"/>
            <arg value="provider/default-idp-2"/>
        </exec>
    </target>

    <!-- =================== Bulk APIs =================== -->
    <target name="bulk-apis" depends="login">
        <echo message="ðŸ“¦ Processing all APIs in ${APIS_DIR}/ folder..."/>
        <foreach target="process-api" param="api.file">
            <path>
                <fileset dir="${APIS_DIR}" includes="*.yaml"/>
            </path>
        </foreach>
    </target>

    <target name="process-api">
        <!-- get base name without extension -->
        <basename property="api.basename" file="@{api.file}" suffix=".yaml"/>

        <!-- split on first "_" (API_NAME vs API_VERSION) -->
        <propertyregex property="API_NAME" input="${api.basename}" regexp="^([^_]+)_.*$" select="\1"/>
        <propertyregex property="API_VERSION" input="${api.basename}" regexp="^[^_]+_(.*)$" select="\1"/>

        <echo message="âž¡ï¸ Handling API: ${API_NAME}_${API_VERSION}"/>

        <!-- validate -->
        <exec executable="apic" failonerror="true">
            <arg value="draft-apis:validate"/>
            <arg value="@{api.file}"/>
        </exec>

        <!-- create/update draft API -->
        <exec executable="apic" failonerror="false">
            <arg value="draft-apis:create"/>
            <arg value="@{api.file}"/>
            <arg value="--server"/>
            <arg value="${SERVER}"/>
            <arg value="--org"/>
            <arg value="${ORG}"/>
        </exec>
    </target>

    <!-- =================== Bulk Products =================== -->
    <target name="bulk-products" depends="bulk-apis">
        <echo message="ðŸ“¦ Processing all Products in ${PRODUCTS_DIR}/ folder..."/>
        <foreach target="process-product" param="product.file">
            <path>
                <fileset dir="${PRODUCTS_DIR}" includes="*.yaml"/>
            </path>
        </foreach>
    </target>

    <target name="process-product">
        <basename property="product.basename" file="@{product.file}" suffix=".yaml"/>
        <propertyregex property="PRODUCT_NAME" input="${product.basename}" regexp="^([^_]+)_.*$" select="\1"/>
        <propertyregex property="PRODUCT_VERSION" input="${product.basename}" regexp="^[^_]+_(.*)$" select="\1"/>

        <echo message="âž¡ï¸ Handling Product: ${PRODUCT_NAME}_${PRODUCT_VERSION}"/>

        <!-- create/update draft product -->
        <exec executable="apic" failonerror="false">
            <arg value="draft-products:create"/>
            <arg value="@{product.file}"/>
            <arg value="--server"/>
            <arg value="${SERVER}"/>
            <arg value="--org"/>
            <arg value="${ORG}"/>
        </exec>
    </target>

    <!-- =================== CI Entry Point =================== -->
    <target name="ci" depends="bulk-products">
        <echo message="ðŸŽ‰ Bulk CI pipeline completed successfully!"/>
    </target>

</project>
