<project name="apic-cicd-pipeline" default="ci" basedir=".">

    <!-- =================== ant-contrib foreach =================== -->
    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="ant-contrib-1.0b3.jar"/>
        </classpath>
    </taskdef>

    <!-- =================== Login =================== -->
    <target name="login">
        <echo message="ðŸ” Logging in to API Connect..."/>
        <exec executable="apic" failonerror="true">
            <arg value="login"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--username"/>
            <arg value="umesh"/>
            <arg value="--password"/>
            <arg value="!n0r1t5@C"/>
            <arg value="--realm"/>
            <arg value="provider/default-idp-2"/>
        </exec>
    </target>

    <!-- =================== Bulk API Processing =================== -->
    <target name="bulk-apis" depends="login">
        <echo message="ðŸ“¦ Processing all APIs in apis/ folder..."/>
        <foreach target="process-api" param="apiFile">
            <path>
                <fileset dir="apis" includes="*.yaml"/>
            </path>
        </foreach>
    </target>

    <target name="process-api">
        <basename property="apiBase" file="${apiFile}" suffix=".yaml"/>
        <echo message="âž¡ï¸ Handling API: ${apiBase}"/>

        <!-- Validate -->
        <exec executable="apic" failonerror="true">
            <arg value="validate"/>
            <arg value="${apiFile}"/>
        </exec>

        <!-- Create/Update draft API -->
        <exec executable="apic" failonerror="false">
            <arg value="draft-apis:get"/>
            <arg value="${apiBase}"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
        </exec>
        <!-- If not exists, create -->
        <exec executable="apic" failonerror="false">
            <arg value="draft-apis:create"/>
            <arg value="${apiFile}"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
        </exec>
    </target>

    <!-- =================== Fix Product refs =================== -->
    <target name="fix-product-refs" depends="bulk-apis">
        <echo message="ðŸ”§ Fixing product references..."/>
        <exec executable="/var/lib/jenkins/scripts/fix-product-refs.sh" failonerror="true">
            <arg value="${basedir}/products"/>
            <arg value="${basedir}/apis"/>
        </exec>
    </target>

    <!-- =================== Bulk Product Processing =================== -->
    <target name="bulk-products" depends="fix-product-refs">
        <echo message="ðŸ“¦ Processing all Products in products/ folder..."/>
        <foreach target="process-product" param="prodFile">
            <path>
                <fileset dir="products" includes="*.yaml"/>
            </path>
        </foreach>
    </target>

    <target name="process-product">
        <basename property="prodBase" file="${prodFile}" suffix=".yaml"/>
        <echo message="âž¡ï¸ Handling Product: ${prodBase}"/>

        <!-- Create/Update draft Product -->
        <exec executable="apic" failonerror="false">
            <arg value="draft-products:get"/>
            <arg value="${prodBase}"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
        </exec>
        <!-- If not exists, create -->
        <exec executable="apic" failonerror="false">
            <arg value="draft-products:create"/>
            <arg value="${prodFile}"/>
            <arg value="--server"/>
            <arg value="https://small-1-mgmt-api-manager-cp4i.apps.ocp.prontefflabs.com"/>
            <arg value="--org"/>
            <arg value="indusapi-np"/>
        </exec>
    </target>

    <!-- =================== CI Entry Point =================== -->
    <target name="ci" depends="bulk-products">
        <echo message="ðŸŽ‰ Bulk CI pipeline completed successfully!"/>
    </target>

</project>
