<?xml version="1.0" encoding="UTF-8"?>
<project name="apic-cicd" default="ci" basedir=".">

  <!-- ========= PROPERTIES ========= -->
  <property name="apic.host" value="https://apic-server.example.com"/>
  <property name="org" value="myorg"/>
  <property name="catalog" value="${CATALOG_NAME}"/>
  <property name="api" value="apis/${API_NAME}_${API_VERSION}.yaml"/>
  <property name="product" value="products/${PRODUCT_NAME}_${API_VERSION}.yaml"/>

  <!-- ========= TARGETS ========= -->

  <!-- Validate API YAML -->
  <target name="validate">
    <echo message="âœ… Validating API YAML for ${API_NAME}"/>
    <exec executable="apic">
      <arg value="validate"/>
      <arg value="${api}"/>
    </exec>
  </target>

  <!-- Create or Update Draft API -->
  <target name="api-draft" depends="validate">
    <echo message="ðŸ“¦ Creating or Updating draft API ${API_NAME}:${API_VERSION}"/>
    <exec executable="apic">
      <arg value="drafts:create"/>
      <arg value="${api}"/>
      <arg value="--server"/>
      <arg value="${apic.host}"/>
      <arg value="--org"/>
      <arg value="${org}"/>
      <arg value="--api-version"/>
      <arg value="${API_VERSION}"/>
    </exec>
  </target>

  <!-- Update $ref paths in product file -->
  <target name="ref-update">
    <echo message="ðŸ”§ Updating $ref paths in product file: ${product}"/>
    <exec executable="bash">
      <arg value="-c"/>
      <arg value="product='${product}'; awk '
        {
          if (\$0 ~ /^[[:space:]]*\\$ref:[[:space:]]*[^\\.\\/][A-Za-z0-9._-]*\\.yaml([[:space:]]*(#.*)?)?$/ \
           || \$0 ~ /^[[:space:]]*\\$ref:[[:space:]]*[A-Za-z0-9._-]*\\.yaml([[:space:]]*(#.*)?)?$/ ) {
            sub(/\\$ref:[[:space:]]*/, \"&amp;../apis/\");
          }
          print
        }
      ' \"${product}\" > \"${product}.tmp\" &amp;&amp; mv \"${product}.tmp\" \"${product}\""/>
    </exec>
  </target>

  <!-- Create or Update Draft Product (after ref-update) -->
  <target name="product-draft" depends="ref-update">
    <echo message="ðŸ“¦ Creating or Updating draft Product ${PRODUCT_NAME}:${API_VERSION}"/>
    <exec executable="apic">
      <arg value="drafts:create"/>
      <arg value="${product}"/>
      <arg value="--server"/>
      <arg value="${apic.host}"/>
      <arg value="--org"/>
      <arg value="${org}"/>
      <arg value="--product-version"/>
      <arg value="${API_VERSION}"/>
    </exec>
  </target>

  <!-- Publish Product to Catalog -->
  <target name="publish" depends="product-draft">
    <echo message="ðŸš€ Publishing Product ${PRODUCT_NAME}:${API_VERSION} to catalog ${catalog}"/>
    <exec executable="apic">
      <arg value="publish"/>
      <arg value="${product}"/>
      <arg value="--catalog"/>
      <arg value="${catalog}"/>
      <arg value="--server"/>
      <arg value="${apic.host}"/>
      <arg value="--org"/>
      <arg value="${org}"/>
    </exec>
  </target>

  <!-- CI Entry Point -->
  <target name="ci" depends="api-draft,product-draft,publish">
    <echo message="âœ… CI pipeline completed for ${API_NAME}:${API_VERSION}"/>
  </target>

</project>
