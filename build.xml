<?xml version="1.0" encoding="UTF-8"?>
<project name="apic-ci-cd" default="ci">

  <!-- ========= PROPERTIES ========= -->
  <property name="org" value="indusapi"/>
  <property name="catalog" value="${CATALOG_NAME}"/>
  <property name="api" value="apis/${API_NAME}_${API_VERSION}.yaml"/>
  <property name="product" value="products/${PRODUCT_NAME}_${API_VERSION}.yaml"/>

  <!-- ========= VALIDATION ========= -->
  <target name="validate">
    <echo message="âœ… Validating API YAML for ${API_NAME}"/>
    <exec executable="apic">
      <arg value="validate"/>
      <arg value="${api}"/>
    </exec>
  </target>

  <!-- ========= REF UPDATE ========= -->
  <target name="ref-update">
    <echo message="ðŸ”§ Updating $ref paths in product file: ${product}"/>
    <exec executable="bash">
      <arg line="-c 'product=&quot;${product}&quot;; awk &apos;{ if ($0 ~ /^[[:space:]]*\\$ref:[[:space:]]*[A-Za-z0-9._-]+\\.yaml/){ sub(/\\$ref:[[:space:]]*/, &quot;\\$ref: ../apis/&quot;); } print }&apos; &quot;${product}&quot; &gt; &quot;${product}.tmp&quot; &amp;&amp; mv &quot;${product}.tmp&quot; &quot;${product}&quot;'"/>
    </exec>
  </target>

  <!-- ========= API DRAFT ========= -->
  <target name="api-draft" depends="validate">
    <echo message="ðŸ“¦ Creating or Updating draft API ${API_NAME}:${API_VERSION}"/>
    <exec executable="apic">
      <arg value="drafts:apis:create"/>
      <arg value="--server"/>
      <arg value="https://api-manager.indusind.com"/>
      <arg value="--org"/>
      <arg value="${org}"/>
      <arg value="${api}"/>
      <arg value="--catalog"/>
      <arg value="${catalog}"/>
    </exec>
  </target>

  <!-- ========= PRODUCT DRAFT ========= -->
  <target name="product-draft" depends="ref-update,api-draft">
    <echo message="ðŸ“¦ Creating or Updating draft Product ${PRODUCT_NAME}:${API_VERSION}"/>
    <exec executable="apic">
      <arg value="drafts:products:create"/>
      <arg value="--server"/>
      <arg value="https://api-manager.indusind.com"/>
      <arg value="--org"/>
      <arg value="${org}"/>
      <arg value="${product}"/>
      <arg value="--catalog"/>
      <arg value="${catalog}"/>
    </exec>
  </target>

  <!-- ========= PUBLISH ========= -->
  <target name="publish" depends="product-draft">
    <echo message="ðŸš€ Publishing Product ${PRODUCT_NAME}:${API_VERSION} to catalog ${catalog}"/>
    <exec executable="apic">
      <arg value="products:publish"/>
      <arg value="--server"/>
      <arg value="https://api-manager.indusind.com"/>
      <arg value="--org"/>
      <arg value="${org}"/>
      <arg value="${product}"/>
      <arg value="--catalog"/>
      <arg value="${catalog}"/>
    </exec>
  </target>

  <!-- ========= CI PIPELINE ========= -->
  <target name="ci" depends="publish">
    <echo message="âœ… CI Pipeline completed for ${API_NAME}:${API_VERSION}"/>
  </target>

</project>
